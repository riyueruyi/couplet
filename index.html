<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹è”åˆ›ä½œæ”¶é›†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, textarea:focus {
            border-color: #667eea;
            outline: none;
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.6;
        }
        
        .couplet-example {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-style: italic;
            color: #666;
            border-left: 4px solid #667eea;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            display: block;
            margin: 40px auto 0;
            transition: transform 0.3s, box-shadow 0.3s;
            font-weight: bold;
            width: 100%;
            max-width: 300px;
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result-message {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #eee;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .form-container {
                padding: 25px;
            }
            
            .submit-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ å¯¹è”åˆ›ä½œå¾é›†</h1>
            <p>æŒ¥æ¯«æ³¼å¢¨ï¼Œå±•ç°ä½ çš„æ‰åï¼</p>
        </div>
        
        <div class="form-container">
            <div id="message" class="result-message"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æäº¤åˆ°GitHubä»“åº“ï¼Œè¯·ç¨å€™...</p>
            </div>
            
            <form id="coupletForm">
                <div class="form-group">
                    <label for="name">ğŸ“ å§“å/æ˜µç§°ï¼š</label>
                    <input type="text" id="name" name="name" required 
                           placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
                </div>
                
                <div class="form-group">
                    <label for="couplet">ğŸ–‹ï¸ åˆ›ä½œçš„å¯¹è”ï¼š</label>
                    <textarea id="couplet" name="couplet" required 
                              placeholder="è¯·è¾“å…¥æ‚¨åˆ›ä½œçš„å¯¹è”ï¼ˆä¸Šä¸‹è”å’Œæ¨ªæ‰¹ï¼‰"></textarea>
                    <div class="couplet-example">
                        ç¤ºä¾‹ï¼š<br>
                        ä¸Šè”ï¼šæ˜¥æ»¡äººé—´ç™¾èŠ±åè‰³<br>
                        ä¸‹è”ï¼šç¦ä¸´å°é™¢å››å­£å¸¸å®‰<br>
                        æ¨ªæ‰¹ï¼šæ¬¢åº¦æ˜¥èŠ‚
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="class">ğŸ« å­¦é™¢/ç­çº§/å­¦å·ï¼š</label>
                    <input type="text" id="class" name="class" 
                           placeholder="ä¾‹å¦‚ï¼šåœ°ç©ºå­¦é™¢06D255ç­12345678912">
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">æäº¤ä½œå“</button>
            </form>
        </div>
        
        <div class="footer">
            <p>Â© 2025 å¯¹è”åˆ›ä½œæ´»åŠ¨ | ä½œå“å°†ä¿å­˜ä¸ºTXTæ–‡ä»¶è‡³GitHubä»“åº“</p>
        </div>
    </div>

    <script>
        // ===================== é…ç½®åŒºåŸŸ =====================
        // é‡è¦ï¼šè¯·å°†ä»¥ä¸‹é…ç½®ä¿®æ”¹ä¸ºæ‚¨è‡ªå·±çš„GitHubä¿¡æ¯
        
        const GITHUB_CONFIG = {
            // GitHubç”¨æˆ·å
            username: 'YOUR_GITHUB_USERNAME',
            
            // ä»“åº“å
            repo: 'YOUR_REPO_NAME',
            
            // åˆ†æ”¯åï¼ˆé€šå¸¸æ˜¯mainæˆ–masterï¼‰
            branch: 'main',
            
            // å­˜å‚¨æ–‡ä»¶çš„æ–‡ä»¶å¤¹è·¯å¾„
            folderPath: 'submissions',
            
            // GitHub Personal Access Tokenï¼ˆéœ€è¦æœ‰repoæƒé™ï¼‰
            // é‡è¦ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”è¯¥ä½¿ç”¨åç«¯æœåŠ¡å™¨æ¥ä¿æŠ¤token
            token: 'YOUR_GITHUB_PERSONAL_ACCESS_TOKEN'
        };
        
        // ===================== å·¥å…·å‡½æ•° =====================
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = text;
            messageDiv.className = `result-message ${type}`;
            messageDiv.style.display = 'block';
            
            // å¦‚æœæ˜¯æˆåŠŸæ¶ˆæ¯ï¼Œ10ç§’åè‡ªåŠ¨éšè—
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 10000);
            }
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶åï¼ˆåŒ…å«æ—¶é—´æˆ³å’Œå§“åï¼‰
        function generateFileName(name) {
            const now = new Date();
            const timestamp = now.toISOString()
                .replace(/[:.]/g, '-')
                .replace('T', '_')
                .substring(0, 19);
            
            // æ¸…ç†å§“åä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼Œåªä¿ç•™ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—å’Œä¸‹åˆ’çº¿
            const safeName = name.replace(/[^\w\u4e00-\u9fa5]/g, '_');
            
            // å¦‚æœå§“åä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤åç§°
            const namePart = safeName || 'anonymous';
            
            // æ·»åŠ éšæœºå­—ç¬¦ä¸²é¿å…é‡å¤
            const randomStr = Math.random().toString(36).substring(2, 8);
            
            return `${timestamp}_${namePart}_${randomStr}.txt`;
        }
        
        // ç”ŸæˆTXTæ–‡ä»¶å†…å®¹
        function generateFileContent(data) {
            const timestamp = new Date(data.timestamp).toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            let content = 'å¯¹è”ä½œå“æäº¤è®°å½•\n';
            content += '='.repeat(30) + '\n\n';
            
            content += 'ã€æäº¤ä¿¡æ¯ã€‘\n';
            content += 'æäº¤æ—¶é—´ï¼š' + timestamp + '\n';
            content += 'ä½œè€…å§“åï¼š' + data.name + '\n';
            
            if (data.classInfo && data.classInfo.trim()) {
                content += 'å­¦é™¢ç­çº§ï¼š' + data.classInfo + '\n';
            }
            
            content += '\nã€ä½œå“å†…å®¹ã€‘\n';
            content += '='.repeat(30) + '\n';
            content += data.couplet + '\n';
            content += '='.repeat(30) + '\n\n';
            
            content += 'ã€ç³»ç»Ÿä¿¡æ¯ã€‘\n';
            content += 'æ–‡ä»¶ç”Ÿæˆæ—¶é—´ï¼š' + new Date().toISOString() + '\n';
            content += 'æäº¤æ–¹å¼ï¼šGitHub APIç›´æ¥æäº¤\n';
            
            return content;
        }
        
        // å°†å­—ç¬¦ä¸²ç¼–ç ä¸ºBase64ï¼ˆå…¼å®¹ä¸­æ–‡ï¼‰
        function encodeToBase64(str) {
            try {
                // é¦–å…ˆå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºUTF-8å­—èŠ‚æ•°ç»„
                const utf8Bytes = new TextEncoder().encode(str);
                
                // å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºäºŒè¿›åˆ¶å­—ç¬¦ä¸²
                let binaryString = '';
                for (let i = 0; i < utf8Bytes.length; i++) {
                    binaryString += String.fromCharCode(utf8Bytes[i]);
                }
                
                // ä½¿ç”¨btoaè¿›è¡ŒBase64ç¼–ç 
                return btoa(binaryString);
            } catch (error) {
                console.error('Base64ç¼–ç å¤±è´¥:', error);
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æ—§çš„unescape/encodeURIComponentæ–¹æ³•
                return btoa(unescape(encodeURIComponent(str)));
            }
        }
        
        // éªŒè¯è¡¨å•æ•°æ®
        function validateFormData(name, couplet) {
            if (!name || name.trim().length === 0) {
                return 'è¯·è¾“å…¥å§“åæˆ–æ˜µç§°';
            }
            
            if (!couplet || couplet.trim().length === 0) {
                return 'è¯·è¾“å…¥å¯¹è”å†…å®¹';
            }
            
            if (name.length > 100) {
                return 'å§“åæˆ–æ˜µç§°è¿‡é•¿ï¼ˆä¸è¶…è¿‡100å­—ç¬¦ï¼‰';
            }
            
            if (couplet.length > 5000) {
                return 'å¯¹è”å†…å®¹è¿‡é•¿ï¼ˆä¸è¶…è¿‡5000å­—ç¬¦ï¼‰';
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸Šä¸‹è”å…³é”®è¯ï¼ˆå¯é€‰ï¼‰
            const hasShangLian = couplet.includes('ä¸Šè”') || couplet.includes('ä¸Šè”ï¼š');
            const hasXiaLian = couplet.includes('ä¸‹è”') || couplet.includes('ä¸‹è”ï¼š');
            const hasHengPi = couplet.includes('æ¨ªæ‰¹') || couplet.includes('æ¨ªæ‰¹ï¼š');
            
            if (!hasShangLian && !hasXiaLian) {
                // åªæ˜¯è­¦å‘Šï¼Œä¸æ˜¯é”™è¯¯
                console.log('æç¤ºï¼šå¯¹è”å†…å®¹ä¸­æœªæ˜ç¡®æ ‡æ³¨"ä¸Šè”"å’Œ"ä¸‹è”"');
            }
            
            return null; // éªŒè¯é€šè¿‡
        }
        
        // ===================== GitHub APIå‡½æ•° =====================
        
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
        async function checkFileExists(filePath) {
            try {
                const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                return response.status === 200;
            } catch (error) {
                console.error('æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ—¶å‡ºé”™:', error);
                return false;
            }
        }
        
        // åˆ›å»ºæˆ–æ›´æ–°æ–‡ä»¶åˆ°GitHubä»“åº“
        async function createOrUpdateFile(filePath, content, commitMessage) {
            try {
                const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                
                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œè·å–shaï¼ˆç”¨äºæ›´æ–°ï¼‰
                let sha = null;
                try {
                    const checkResponse = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const existingFile = await checkResponse.json();
                        sha = existingFile.sha;
                        console.log('æ–‡ä»¶å·²å­˜åœ¨ï¼Œå°†è¿›è¡Œæ›´æ–°ï¼Œsha:', sha);
                    }
                } catch (e) {
                    // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µ
                    console.log('æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶');
                }
                
                // å‡†å¤‡è¯·æ±‚æ•°æ®
                const requestData = {
                    message: commitMessage,
                    content: encodeToBase64(content),
                    branch: GITHUB_CONFIG.branch
                };
                
                // å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œæ·»åŠ shaç”¨äºæ›´æ–°
                if (sha) {
                    requestData.sha = sha;
                }
                
                // å‘é€è¯·æ±‚
                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('GitHub APIå“åº”æˆåŠŸ:', result);
                    return {
                        success: true,
                        fileUrl: result.content.html_url,
                        fileName: filePath.split('/').pop(),
                        commitSha: result.commit.sha
                    };
                } else {
                    console.error('GitHub APIé”™è¯¯:', result);
                    let errorMessage = 'æäº¤å¤±è´¥';
                    
                    if (result.message) {
                        if (result.message.includes('sha')) {
                            errorMessage = 'æ–‡ä»¶å·²å­˜åœ¨æˆ–å‘ç”Ÿå†²çªï¼Œè¯·ç¨åé‡è¯•';
                        } else if (result.message.includes('invalid')) {
                            errorMessage = 'æäº¤å†…å®¹æ ¼å¼æ— æ•ˆ';
                        } else if (result.message.includes('rate limit')) {
                            errorMessage = 'APIè¯·æ±‚æ¬¡æ•°è¶…é™ï¼Œè¯·ç¨åå†è¯•';
                        } else {
                            errorMessage = `GitHubé”™è¯¯: ${result.message}`;
                        }
                    }
                    
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('åˆ›å»ºæˆ–æ›´æ–°æ–‡ä»¶å¤±è´¥:', error);
                throw error;
            }
        }
        
        // ===================== æäº¤å¤„ç†å‡½æ•° =====================
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function saveToLocalStorage(data) {
            try {
                const submissions = JSON.parse(localStorage.getItem('coupletSubmissions') || '[]');
                
                const submissionWithId = {
                    id: Date.now().toString() + Math.random().toString(36).substring(2, 9),
                    timestamp: new Date().toISOString(),
                    ...data
                };
                
                submissions.push(submissionWithId);
                
                // é™åˆ¶æœ¬åœ°å­˜å‚¨æ•°é‡ï¼Œæœ€å¤šä¿å­˜100æ¡
                if (submissions.length > 100) {
                    submissions.splice(0, submissions.length - 100);
                }
                
                localStorage.setItem('coupletSubmissions', JSON.stringify(submissions));
                
                console.log('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ŒID:', submissionWithId.id);
                return submissionWithId.id;
            } catch (error) {
                console.error('æœ¬åœ°å­˜å‚¨ä¿å­˜å¤±è´¥:', error);
                return null;
            }
        }
        
        // å¯¼å‡ºæœ¬åœ°å­˜å‚¨çš„æ•°æ®
        function exportLocalSubmissions() {
            try {
                const submissions = JSON.parse(localStorage.getItem('coupletSubmissions') || '[]');
                
                if (submissions.length === 0) {
                    alert('æœ¬åœ°æ²¡æœ‰ä¿å­˜çš„ä½œå“');
                    return;
                }
                
                // åˆ›å»ºå¯¼å‡ºå†…å®¹
                let exportContent = 'æœ¬åœ°å­˜å‚¨çš„å¯¹è”ä½œå“å¤‡ä»½\n';
                exportContent += '='.repeat(40) + '\n\n';
                
                submissions.forEach((item, index) => {
                    exportContent += `ä½œå“ ${index + 1} (ID: ${item.id})\n`;
                    exportContent += `ä¿å­˜æ—¶é—´: ${new Date(item.timestamp).toLocaleString('zh-CN')}\n`;
                    exportContent += `ä½œè€…: ${item.name}\n`;
                    
                    if (item.classInfo) {
                        exportContent += `ç­çº§: ${item.classInfo}\n`;
                    }
                    
                    exportContent += `å†…å®¹:\n${item.couplet}\n\n`;
                    exportContent += '-'.repeat(40) + '\n\n';
                });
                
                // åˆ›å»ºä¸‹è½½
                const blob = new Blob([exportContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `couplet_backup_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('æ•°æ®å¯¼å‡ºå®Œæˆ');
                showMessage(`âœ… å·²å¯¼å‡º ${submissions.length} æ¡æœ¬åœ°ä½œå“`, 'success');
                
            } catch (error) {
                console.error('æ•°æ®å¯¼å‡ºå¤±è´¥:', error);
                showMessage('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ä¸»æäº¤å‡½æ•°
        async function submitToGitHub(data) {
            const submitBtn = document.getElementById('submitBtn');
            
            // ç¦ç”¨æäº¤æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';
            showLoading(true);
            
            try {
                // 1. éªŒè¯é…ç½®
                if (GITHUB_CONFIG.token.includes('YOUR_') || 
                    GITHUB_CONFIG.username.includes('YOUR_') || 
                    GITHUB_CONFIG.repo.includes('YOUR_')) {
                    throw new Error('è¯·å…ˆé…ç½®GitHubä¿¡æ¯ï¼è¯·ä¿®æ”¹GITHUB_CONFIGä¸­çš„å€¼ã€‚');
                }
                
                // 2. ç”Ÿæˆæ–‡ä»¶åå’Œè·¯å¾„
                const fileName = generateFileName(data.name);
                const filePath = `${GITHUB_CONFIG.folderPath}/${fileName}`;
                
                // 3. ç”Ÿæˆæ–‡ä»¶å†…å®¹
                const fileContent = generateFileContent(data);
                
                // 4. æäº¤åˆ°GitHub
                const commitMessage = `æ·»åŠ å¯¹è”ä½œå“: ${data.name}`;
                const result = await createOrUpdateFile(filePath, fileContent, commitMessage);
                
                if (result.success) {
                    // 5. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    let successMessage = `âœ… æ„Ÿè°¢ <strong>${data.name}</strong> æäº¤ä½œå“ï¼<br>`;
                    successMessage += `æ–‡ä»¶ <strong>"${result.fileName}"</strong> å·²ä¿å­˜åˆ°GitHubä»“åº“ã€‚<br>`;
                    
                    // æ·»åŠ æ–‡ä»¶é“¾æ¥
                    if (result.fileUrl) {
                        successMessage += `<a href="${result.fileUrl}" target="_blank" style="color: #155724; text-decoration: underline;">æŸ¥çœ‹æ–‡ä»¶</a> | `;
                    }
                    
                    // æ·»åŠ æŸ¥çœ‹æ–‡ä»¶å¤¹é“¾æ¥
                    const folderUrl = `https://github.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/tree/main/${GITHUB_CONFIG.folderPath}`;
                    successMessage += `<a href="${folderUrl}" target="_blank" style="color: #155724; text-decoration: underline;">æŸ¥çœ‹æ‰€æœ‰ä½œå“</a>`;
                    
                    showMessage(successMessage, 'success');
                    
                    // 6. ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ä»½
                    saveToLocalStorage(data);
                    
                    return true;
                } else {
                    throw new Error('æäº¤å¤±è´¥ï¼ŒæœªçŸ¥é”™è¯¯');
                }
                
            } catch (error) {
                console.error('æäº¤è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                
                // å¦‚æœGitHubæäº¤å¤±è´¥ï¼Œä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                const localId = saveToLocalStorage(data);
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                let errorMessage = `âš ï¸ GitHubæäº¤å¤±è´¥ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ã€‚<br>é”™è¯¯: ${error.message}`;
                
                if (localId) {
                    errorMessage += `<br>æœ¬åœ°ID: ${localId}`;
                }
                
                showMessage(errorMessage, 'error');
                
                return false;
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.textContent = 'æäº¤ä½œå“';
                showLoading(false);
            }
        }
        
        // ===================== äº‹ä»¶ç›‘å¬ =====================
        
        document.getElementById('coupletForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const couplet = document.getElementById('couplet').value.trim();
            const classInfo = document.getElementById('class').value.trim();
            
            // éªŒè¯è¾“å…¥
            const validationError = validateFormData(name, couplet);
            if (validationError) {
                showMessage(`âŒ ${validationError}`, 'error');
                return;
            }
            
            // å‡†å¤‡æäº¤æ•°æ®
            const submission = {
                name: name,
                couplet: couplet,
                classInfo: classInfo,
                timestamp: new Date().toISOString()
            };
            
            // æäº¤åˆ°GitHub
            const success = await submitToGitHub(submission);
            
            if (success) {
                // æ¸…ç©ºè¡¨å•
                document.getElementById('coupletForm').reset();
                
                // 10ç§’åéšè—æˆåŠŸæ¶ˆæ¯
                setTimeout(() => {
                    document.getElementById('message').style.display = 'none';
                }, 10000);
            }
        });
        
        // ===================== é¡µé¢åˆå§‹åŒ– =====================
        
        window.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const fromQR = urlParams.get('fromQR');
            
            if (fromQR === 'true') {
                showMessage('ğŸ“± æ¬¢è¿é€šè¿‡æ‰«ç è®¿é—®å¯¹è”åˆ›ä½œé¡µé¢ï¼è¯·å¡«å†™æ‚¨çš„ä½œå“ã€‚', 'success');
                setTimeout(() => {
                    document.getElementById('message').style.display = 'none';
                }, 3000);
            }
            
            // æ˜¾ç¤ºé…ç½®æé†’ï¼ˆä»…å¼€å‘æ—¶ä½¿ç”¨ï¼‰
            if (GITHUB_CONFIG.token.includes('YOUR_') || 
                GITHUB_CONFIG.username.includes('YOUR_') || 
                GITHUB_CONFIG.repo.includes('YOUR_')) {
                console.warn('âš ï¸ è¯·å…ˆé…ç½®GITHUB_CONFIGä¸­çš„å€¼ï¼');
                showMessage('âš ï¸ å¼€å‘æç¤ºï¼šè¯·é…ç½®GitHub APIä¿¡æ¯ä»¥å¯ç”¨æäº¤åŠŸèƒ½', 'error');
                setTimeout(() => {
                    document.getElementById('message').style.display = 'none';
                }, 5000);
            }
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
            try {
                const submissions = JSON.parse(localStorage.getItem('coupletSubmissions') || '[]');
                if (submissions.length > 0) {
                    console.log(`æœ¬åœ°ä¿å­˜äº† ${submissions.length} æ¡ä½œå“`);
                    
                    // å¦‚æœæœ‰æœªåŒæ­¥çš„ä½œå“ï¼Œæ˜¾ç¤ºæç¤º
                    const unsyncedCount = submissions.length;
                    if (unsyncedCount > 0) {
                        console.log(`æœ‰ ${unsyncedCount} æ¡æœ¬åœ°ä¿å­˜çš„ä½œå“`);
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
            }
            
            // æ·»åŠ ç®¡ç†åŠŸèƒ½åˆ°æ§åˆ¶å°
            console.log('å¯¹è”æ”¶é›†ç³»ç»Ÿå·²åŠ è½½');
            console.log('å¯ç”¨ç®¡ç†å‡½æ•°: exportLocalSubmissions()');
        });
        
        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // Ctrl+Shift+E å¯¼å‡ºæœ¬åœ°æ•°æ®
            if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                e.preventDefault();
                exportLocalSubmissions();
            }
            
            // Ctrl+Enter æäº¤è¡¨å•
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('submitBtn').click();
            }
        });
        
    </script>
</body>
</html>